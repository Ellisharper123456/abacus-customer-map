<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Abacus Installation Map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #2E4591 0%, #00ABED 100%);
            min-height: 100vh;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            padding: 1.5rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
        }

        .header h1 {
            color: #333;
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .header p {
            color: #666;
            font-size: 1rem;
        }

        .container {
            max-width: 1400px;
            margin: 2rem auto;
            padding: 0 1rem;
        }

        .controls {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
            align-items: center;
        }

        .filter-group {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            align-items: center;
        }

        .filter-label {
            color: white;
            font-weight: 600;
            margin-right: 0.5rem;
        }

        .btn-filter {
            padding: 0.5rem 1rem;
            border: 2px solid white;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            transition: all 0.3s;
        }

        .btn-filter:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .btn-filter.active {
            background: white;
            color: #2E4591;
        }

        .admin-toggle {
            margin-left: auto;
            padding: 0.5rem 1rem;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 2px solid white;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .admin-toggle:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .admin-mode .admin-toggle {
            background: #00ABED;
            border-color: #00ABED;
        }

        .admin-only {
            display: none;
        }

        .admin-mode .admin-only {
            display: flex;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .btn-primary {
            background: #2E4591;
            color: white;
        }

        .btn-primary:hover {
            background: #00ABED;
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
        }

        .btn-secondary {
            background: #00ABED;
            color: white;
        }

        .btn-secondary:hover {
            background: #2E4591;
            transform: translateY(-2px);
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1.5rem;
        }

        #map {
            height: 600px;
            border-radius: 12px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.2);
            border: 3px solid white;
        }

        .gallery {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 8px 16px rgba(0,0,0,0.2);
        }

        .gallery h2 {
            margin-bottom: 1.5rem;
            color: #333;
            font-size: 1.8rem;
        }

        .gallery-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
        }

        .installation-card {
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            overflow: hidden;
            transition: transform 0.3s, box-shadow 0.3s;
            cursor: pointer;
        }

        .installation-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 16px rgba(0,0,0,0.15);
        }

        .card-image {
            width: 100%;
            height: 200px;
            object-fit: cover;
            background: #f7fafc;
        }

        .card-content {
            padding: 1rem;
        }

        .card-content h3 {
            color: #2d3748;
            margin-bottom: 0.5rem;
            font-size: 1.1rem;
        }

        .card-content p {
            color: #718096;
            font-size: 0.9rem;
            margin-bottom: 0.3rem;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            overflow-y: auto;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }

        .modal-close {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: #00ABED;
            color: white;
            border: none;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2rem;
            line-height: 1;
        }

        .modal-close:hover {
            background: #2E4591;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: #2d3748;
            font-weight: 600;
        }

        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #2E4591;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .image-preview {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            margin-top: 0.5rem;
        }

        .preview-item {
            position: relative;
            width: 100px;
            height: 100px;
        }

        .preview-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 6px;
            border: 2px solid #e2e8f0;
        }

        .preview-item button {
            position: absolute;
            top: -8px;
            right: -8px;
            background: #00ABED;
            color: white;
            border: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 0.8rem;
        }

        .detail-modal .modal-content {
            max-width: 800px;
        }

        .detail-images {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin: 1rem 0;
        }

        .detail-images img {
            width: 100%;
            height: 200px;
            object-fit: cover;
            border-radius: 8px;
            cursor: pointer;
        }

        .detail-info {
            margin: 1rem 0;
        }

        .detail-info h3 {
            color: #2d3748;
            margin-bottom: 1rem;
            font-size: 1.5rem;
        }

        .detail-info p {
            color: #4a5568;
            margin-bottom: 0.5rem;
            line-height: 1.6;
        }

        .detail-info strong {
            color: #2d3748;
        }

        .empty-state {
            text-align: center;
            padding: 3rem;
            color: #718096;
        }

        .empty-state svg {
            width: 100px;
            height: 100px;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .distance-calculator {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 8px 16px rgba(0,0,0,0.2);
        }

        .distance-calculator h3 {
            color: #2E4591;
            margin-bottom: 1rem;
            font-size: 1.2rem;
        }

        .distance-input-group {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .distance-input-group input {
            flex: 1;
            padding: 0.75rem;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            font-size: 1rem;
        }

        .distance-input-group button {
            padding: 0.75rem 1.5rem;
            background: #2E4591;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
        }

        .distance-input-group button:hover {
            background: #00ABED;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.5rem;
            }

            #map {
                height: 400px;
            }

            .gallery-grid {
                grid-template-columns: 1fr;
            }

            .modal-content {
                padding: 1.5rem;
            }
        }

        .leaflet-popup-content {
            margin: 1rem;
            min-width: 200px;
        }

        .popup-content h3 {
            margin-bottom: 0.5rem;
            color: #2d3748;
        }

        .popup-content p {
            margin: 0.25rem 0;
            color: #4a5568;
            font-size: 0.9rem;
        }

        .popup-content button {
            margin-top: 0.5rem;
            padding: 0.5rem 1rem;
            background: #2E4591;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .popup-content button:hover {
            background: #00ABED;
        }

        .enquiry-section {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid #e2e8f0;
        }

        .enquiry-section h4 {
            color: #2d3748;
            margin-bottom: 0.5rem;
            font-size: 1rem;
        }

        .enquiry-buttons {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .enquiry-buttons button {
            flex: 1;
            padding: 0.5rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.85rem;
        }

        .btn-phone {
            background: #48bb78;
            color: white;
        }

        .btn-phone:hover {
            background: #38a169;
        }

        .btn-visit {
            background: #2E4591;
            color: white;
        }

        .btn-visit:hover {
            background: #00ABED;
        }

        .distance-badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            background: #00ABED;
            color: white;
            border-radius: 4px;
            font-size: 0.85rem;
            font-weight: 600;
            margin-left: 0.5rem;
        }

        .btn-delete {
            background: #e53e3e;
            color: white;
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            margin-top: 1rem;
            width: 100%;
        }

        .btn-delete:hover {
            background: #c53030;
        }

        .admin-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .admin-actions button {
            flex: 1;
        }
    </style>
</head>
<body>
    <div class="header">
        <img src="Abacus Logo Colour.jpg" alt="Abacus Energy Solutions" style="max-width: 180px; height: auto; margin-bottom: 1rem; display: block; margin-left: auto; margin-right: auto;">
        <h1>Installation Map</h1>
        <p>Showcasing our successful renewable energy installations across the UK</p>
    </div>

    <div class="container">
        <div class="controls">
            <div class="filter-group">
                <span class="filter-label">Filter by Technology:</span>
                <button class="btn-filter active" onclick="filterTechnology('all')" data-filter="all">All</button>
                <button class="btn-filter" onclick="toggleFilter('solar')" data-filter="solar">Solar PV</button>
                <button class="btn-filter" onclick="toggleFilter('heat-pump')" data-filter="heat-pump">Heat Pumps</button>
                <button class="btn-filter" onclick="toggleFilter('battery')" data-filter="battery">Battery Storage</button>
                <button class="btn-filter" onclick="toggleFilter('ev-charger')" data-filter="ev-charger">EV Chargers</button>
            </div>
            <button class="admin-toggle" onclick="toggleAdminMode()">üîê Admin Mode</button>
        </div>
        <div class="controls admin-only">
            <button class="btn btn-primary" onclick="openAddModal()">+ Add New Installation</button>
            <button class="btn btn-secondary" onclick="exportData()">üíæ Export Data</button>
        </div>

        <div class="main-content">
            <div class="distance-calculator">
                <h3>üìç Find Installations Near You</h3>
                <p style="color: #718096; margin-bottom: 1rem;">Enter your postcode to see completed installations in your area</p>
                <div class="distance-input-group">
                    <input type="text" id="postcodeInput" placeholder="Enter your postcode (e.g., L30 1RD)">
                    <button onclick="findNearbyInstallations()">Search</button>
                </div>
            </div>

            <div id="map"></div>

            <div class="gallery">
                <h2>Our Completed Installations</h2>
                <div id="gallery-grid" class="gallery-grid">
                    <div class="empty-state">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                        <p>No installations yet. Click "Add New Installation" to get started!</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Installation Modal -->
    <div id="addModal" class="modal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeAddModal()">√ó</button>
            <h2>Add New Installation</h2>
            <form id="installationForm" onsubmit="handleSubmit(event)">
                <div class="form-group">
                    <label for="customerName">Customer Name *</label>
                    <input type="text" id="customerName" required>
                </div>

                <div class="form-group">
                    <label for="address">Address *</label>
                    <input type="text" id="address" required placeholder="123 High Street, Liverpool, UK">
                </div>

                <div class="form-group">
                    <label for="technologyType">Technology Type * (Select all that apply)</label>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.5rem; margin-top: 0.5rem;">
                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                            <input type="checkbox" name="technology" value="solar" style="width: auto;">
                            <span>‚òÄÔ∏è Solar PV</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                            <input type="checkbox" name="technology" value="heat-pump" style="width: auto;">
                            <span>üî• Heat Pump</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                            <input type="checkbox" name="technology" value="battery" style="width: auto;">
                            <span>üîã Battery Storage</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                            <input type="checkbox" name="technology" value="ev-charger" style="width: auto;">
                            <span>‚ö° EV Charger</span>
                        </label>
                    </div>
                </div>

                <div class="form-group">
                    <label for="productInstalled">Product Details *</label>
                    <input type="text" id="productInstalled" required placeholder="e.g., 12x 400W Solar Panels, Mitsubishi ASHP">
                </div>

                <div class="form-group">
                    <label for="installDate">Installation Date</label>
                    <input type="date" id="installDate">
                </div>

                <div class="form-group">
                    <label for="description">Description</label>
                    <textarea id="description" placeholder="Additional details about the installation..."></textarea>
                </div>

                <div class="form-group">
                    <label for="images">Upload Images</label>
                    <input type="file" id="images" accept="image/*" multiple onchange="handleImagePreview(event)">
                    <div id="imagePreview" class="image-preview"></div>
                </div>

                <button type="submit" class="btn btn-primary" style="width: 100%;">Add Installation</button>
            </form>
        </div>
    </div>

    <!-- Detail Modal -->
    <div id="detailModal" class="modal detail-modal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeDetailModal()">√ó</button>
            <div id="detailContent"></div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // Initialize map centred on North West UK (Liverpool area)
        let map = L.map('map').setView([53.4721, -2.9578], 8);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap contributors'
        }).addTo(map);

        // Storage key
        const STORAGE_KEY = 'abacus_installations';
        
        // State management
        let currentImages = [];
        let installations = loadInstallations();
        let isAdminMode = false;
        let activeFilters = ['all']; // Array to support multiple filters
        let userLocation = null;
        
        // Privacy settings
        const PRIVACY_RADIUS_KM = 0.5; // Show approximate location within 500m

        // Load installations from localStorage
        function loadInstallations() {
            const data = localStorage.getItem(STORAGE_KEY);
            return data ? JSON.parse(data) : [];
        }
        
        // Toggle admin mode
        function toggleAdminMode() {
            const password = prompt('Enter admin password:');
            if (password === 'abacus2025') {
                isAdminMode = !isAdminMode;
                document.body.classList.toggle('admin-mode', isAdminMode);
                renderInstallations();
                alert(isAdminMode ? 'Admin mode enabled' : 'Admin mode disabled');
            } else if (password !== null) {
                alert('Incorrect password');
            }
        }
        
        // Filter by single technology (All button)
        function filterTechnology(tech) {
            activeFilters = [tech];
            document.querySelectorAll('.btn-filter').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.filter === tech);
            });
            renderInstallations();
        }
        
        // Toggle filter (multi-select for specific technologies)
        function toggleFilter(tech) {
            // Remove 'all' if it's active
            if (activeFilters.includes('all')) {
                activeFilters = [];
            }
            
            // Toggle the filter
            const index = activeFilters.indexOf(tech);
            if (index > -1) {
                activeFilters.splice(index, 1);
            } else {
                activeFilters.push(tech);
            }
            
            // If no filters selected, default to 'all'
            if (activeFilters.length === 0) {
                activeFilters = ['all'];
            }
            
            // Update button states
            document.querySelectorAll('.btn-filter').forEach(btn => {
                const filterValue = btn.dataset.filter;
                if (filterValue === 'all') {
                    btn.classList.toggle('active', activeFilters.includes('all'));
                } else {
                    btn.classList.toggle('active', activeFilters.includes(filterValue));
                }
            });
            
            renderInstallations();
        }
        
        // Randomize location for privacy (offset by up to PRIVACY_RADIUS_KM)
        function getPrivateLocation(lat, lng) {
            if (isAdminMode) return { lat, lng };
            
            // Offset in kilometers
            const offsetKm = PRIVACY_RADIUS_KM;
            const latOffset = (Math.random() - 0.5) * (offsetKm / 111); // 1 degree lat ‚âà 111km
            const lngOffset = (Math.random() - 0.5) * (offsetKm / (111 * Math.cos(lat * Math.PI / 180)));
            
            return {
                lat: lat + latOffset,
                lng: lng + lngOffset
            };
        }
        
        // Get anonymized address
        function getPrivateAddress(address) {
            if (isAdminMode) return address;
            
            // Extract postcode area (e.g., "L30" from "L30 1RD")
            const postcodeMatch = address.match(/([A-Z]{1,2}\d{1,2}[A-Z]?)\s*\d[A-Z]{2}/i);
            if (postcodeMatch) {
                return `${postcodeMatch[1]} Area`;
            }
            
            // Fallback: show only city/town
            const parts = address.split(',');
            if (parts.length >= 2) {
                return parts[parts.length - 2].trim() + ' Area';
            }
            
            return 'Local Area';
        }
        
        // Calculate distance between two coordinates (Haversine formula)
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // Earth's radius in km
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }
        
        // Find nearby installations
        async function findNearbyInstallations() {
            const postcode = document.getElementById('postcodeInput').value.trim();
            if (!postcode) {
                alert('Please enter a postcode');
                return;
            }
            
            const coords = await geocodeAddress(postcode);
            if (!coords) {
                alert('Could not find that postcode. Please try again.');
                return;
            }
            
            userLocation = coords;
            
            // Calculate distances and sort
            installations.forEach(install => {
                install.distance = calculateDistance(
                    coords.lat, coords.lng,
                    install.coordinates.lat, install.coordinates.lng
                );
            });
            
            // Zoom to user location
            map.setView([coords.lat, coords.lng], 11);
            
            // Re-render with distances
            renderInstallations();
        }

        // Save installations to localStorage
        function saveInstallations() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(installations));
        }

        // Handle image preview
        function handleImagePreview(event) {
            const files = event.target.files;
            const previewContainer = document.getElementById('imagePreview');
            
            Array.from(files).forEach((file, index) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    currentImages.push(e.target.result);
                    
                    const previewItem = document.createElement('div');
                    previewItem.className = 'preview-item';
                    previewItem.innerHTML = `
                        <img src="${e.target.result}" alt="Preview">
                        <button type="button" onclick="removeImage(${currentImages.length - 1})">√ó</button>
                    `;
                    previewContainer.appendChild(previewItem);
                };
                reader.readAsDataURL(file);
            });
        }

        // Remove image from preview
        function removeImage(index) {
            currentImages.splice(index, 1);
            const previewContainer = document.getElementById('imagePreview');
            previewContainer.innerHTML = '';
            currentImages.forEach((img, i) => {
                const previewItem = document.createElement('div');
                previewItem.className = 'preview-item';
                previewItem.innerHTML = `
                    <img src="${img}" alt="Preview">
                    <button type="button" onclick="removeImage(${i})">√ó</button>
                `;
                previewContainer.appendChild(previewItem);
            });
        }

        // Geocode address using Nominatim
        async function geocodeAddress(address) {
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}`);
                const data = await response.json();
                if (data && data.length > 0) {
                    return {
                        lat: parseFloat(data[0].lat),
                        lng: parseFloat(data[0].lon)
                    };
                }
            } catch (error) {
                console.error('Geocoding error:', error);
            }
            return null;
        }

        // Handle form submission
        async function handleSubmit(event) {
            event.preventDefault();
            
            const customerName = document.getElementById('customerName').value;
            const address = document.getElementById('address').value;
            
            // Get selected technologies
            const technologyCheckboxes = document.querySelectorAll('input[name="technology"]:checked');
            const technologyTypes = Array.from(technologyCheckboxes).map(cb => cb.value);
            
            if (technologyTypes.length === 0) {
                alert('Please select at least one technology type');
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
                return;
            }
            
            const productInstalled = document.getElementById('productInstalled').value;
            const installDate = document.getElementById('installDate').value;
            const description = document.getElementById('description').value;

            // Show loading state
            const submitBtn = event.target.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;
            submitBtn.textContent = 'Adding...';
            submitBtn.disabled = true;

            // Geocode the address
            const coords = await geocodeAddress(address);
            
            if (!coords) {
                alert('Could not find the address. Please check and try again.');
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
                return;
            }

            // Create installation object
            const installation = {
                id: Date.now(),
                customerName,
                address,
                technologyTypes: technologyTypes, // Array of technologies
                productInstalled,
                installDate: installDate || new Date().toISOString().split('T')[0],
                description,
                images: [...currentImages],
                coordinates: coords,
                createdAt: new Date().toISOString()
            };

            // Add to installations array
            installations.push(installation);
            saveInstallations();

            // Reset form
            document.getElementById('installationForm').reset();
            document.querySelectorAll('input[name="technology"]').forEach(cb => cb.checked = false);
            document.getElementById('imagePreview').innerHTML = '';
            currentImages = [];

            // Close modal and refresh display
            closeAddModal();
            renderInstallations();

            submitBtn.textContent = originalText;
            submitBtn.disabled = false;
        }

        // Render installations on map and gallery
        function renderInstallations() {
            // Clear existing markers
            map.eachLayer(layer => {
                if (layer instanceof L.Marker) {
                    map.removeLayer(layer);
                }
            });

            // Clear gallery
            const galleryGrid = document.getElementById('gallery-grid');
            galleryGrid.innerHTML = '';

            // Filter installations
            let filteredInstallations = installations.filter(install => {
                if (activeFilters.includes('all')) return true;
                // Check if installation has any of the selected technologies
                const techs = install.technologyTypes || (install.technologyType ? [install.technologyType] : []);
                return techs.some(tech => activeFilters.includes(tech));
            });

            if (filteredInstallations.length === 0) {
                galleryGrid.innerHTML = `
                    <div class="empty-state">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                        <p>No installations found for this filter.</p>
                    </div>
                `;
                return;
            }
            
            // Sort by distance if user location is set
            if (userLocation) {
                filteredInstallations.sort((a, b) => (a.distance || Infinity) - (b.distance || Infinity));
            }

            // Add markers and gallery items
            filteredInstallations.forEach(installation => {
                const privateCoords = getPrivateLocation(installation.coordinates.lat, installation.coordinates.lng);
                const privateAddress = getPrivateAddress(installation.address);
                // Add marker to map
                const marker = L.marker([privateCoords.lat, privateCoords.lng])
                    .addTo(map);
                
                const distanceBadge = installation.distance ? 
                    `<span class="distance-badge">${installation.distance.toFixed(1)} km away</span>` : '';
                
                let installTechs = installation.technologyTypes || (installation.technologyType ? [installation.technologyType] : ['solar']);
                let installTechLabels = installTechs.map(t => getTechnologyLabel(t)).join(', ');
                
                marker.bindPopup(`
                    <div class="popup-content">
                        <h3>${isAdminMode ? installation.customerName : privateAddress}${distanceBadge}</h3>
                        <p><strong>Technology:</strong> ${installTechLabels}</p>
                        <p><strong>Product:</strong> ${installation.productInstalled}</p>
                        <p><strong>Installed:</strong> ${formatDateBritish(installation.installDate)}</p>
                        ${!isAdminMode ? `
                            <div class="enquiry-section">
                                <h4>Interested in this installation?</h4>
                                <div class="enquiry-buttons">
                                    <button class="btn-phone" onclick="requestCallback(${installation.id}, 'phone')">üìû Request Call</button>
                                    <button class="btn-visit" onclick="requestCallback(${installation.id}, 'visit')">üè† Request Visit</button>
                                </div>
                            </div>
                        ` : `
                            <div class="admin-actions">
                                <button onclick="showDetail(${installation.id})" style="background: #2E4591; color: white; padding: 0.5rem 1rem; border: none; border-radius: 4px; cursor: pointer;">View Details</button>
                                <button onclick="deleteInstallation(${installation.id})" class="btn-delete" style="flex: 0.5; margin-top: 0;">üóëÔ∏è Delete</button>
                            </div>
                        `}
                    </div>
                `);

                // Add to gallery
                const card = document.createElement('div');
                card.className = 'installation-card';
                card.onclick = () => showDetail(installation.id);
                
                const imageHtml = installation.images.length > 0 
                    ? `<img src="${installation.images[0]}" alt="${installation.customerName}" class="card-image">`
                    : `<div class="card-image" style="display:flex;align-items:center;justify-content:center;background:#f7fafc;">
                         <svg width="60" height="60" fill="#cbd5e0" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z" clip-rule="evenodd"></path>
                         </svg>
                       </div>`;

                const distanceText = installation.distance ? 
                    `<p><strong>Distance:</strong> <span class="distance-badge" style="margin-left:0;">${installation.distance.toFixed(1)} km</span></p>` : '';
                
                let cardTechs = installation.technologyTypes || (installation.technologyType ? [installation.technologyType] : ['solar']);
                let cardTechLabels = cardTechs.map(t => getTechnologyLabel(t)).join(', ');
                
                card.innerHTML = `
                    ${imageHtml}
                    <div class="card-content">
                        <h3>${isAdminMode ? installation.customerName : privateAddress}</h3>
                        <p><strong>Technology:</strong> ${cardTechLabels}</p>
                        <p><strong>Product:</strong> ${installation.productInstalled}</p>
                        <p><strong>Location:</strong> ${privateAddress}</p>
                        ${distanceText}
                        <p><strong>Date:</strong> ${formatDateBritish(installation.installDate)}</p>
                        ${isAdminMode ? `<button class="btn-delete" onclick="event.stopPropagation(); deleteInstallation(${installation.id})">üóëÔ∏è Delete Installation</button>` : ''}
                    </div>
                `;
                
                galleryGrid.appendChild(card);
            });

            // Fit map to show all markers
            if (filteredInstallations.length > 0) {
                if (userLocation) {
                    // If user searched for location, stay zoomed on their area
                    map.setView([userLocation.lat, userLocation.lng], 11);
                } else {
                    // Otherwise, zoom to fit all filtered installations or default to Liverpool
                    const bounds = L.latLngBounds(filteredInstallations.map(i => {
                        const privateCoords = getPrivateLocation(i.coordinates.lat, i.coordinates.lng);
                        return [privateCoords.lat, privateCoords.lng];
                    }));
                    map.fitBounds(bounds, { padding: [50, 50], maxZoom: 11 });
                }
            } else {
                // No installations, default to Liverpool area
                map.setView([53.4721, -2.9578], 9);
            }
        }
        
        // Get technology label
        function getTechnologyLabel(tech) {
            const labels = {
                'solar': '‚òÄÔ∏è Solar PV',
                'heat-pump': 'üî• Heat Pump',
                'battery': 'üîã Battery Storage',
                'ev-charger': '‚ö° EV Charger',
                'solar-battery': '‚òÄÔ∏èüîã Solar & Battery',
                'heat-pump-solar': 'üî•‚òÄÔ∏è Heat Pump & Solar'
            };
            return labels[tech] || tech;
        }
        
        // Format date to British format (DD/MM/YYYY)
        function formatDateBritish(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            return `${day}/${month}/${year}`;
        }
        
        // Request callback/visit
        function requestCallback(installId, type) {
            const installation = installations.find(i => i.id === installId);
            if (!installation) return;
            
            const typeText = type === 'phone' ? 'phone call' : 'property visit';
            
            // Create a simple form in the modal
            const detailModal = document.getElementById('detailModal');
            const detailContent = document.getElementById('detailContent');
            
            detailContent.innerHTML = `
                <h3>Request a ${typeText === 'phone call' ? 'Callback' : 'Property Visit'}</h3>
                <p style="color: #718096; margin: 1rem 0;">We'll connect you with the customer who had this installation so you can learn more about their experience.</p>
                <form id="enquiryForm" onsubmit="submitEnquiry(event, ${installId}, '${type}')">
                    <div class="form-group">
                        <label>Your Name *</label>
                        <input type="text" id="enquiryName" required>
                    </div>
                    <div class="form-group">
                        <label>Phone Number *</label>
                        <input type="tel" id="enquiryPhone" required placeholder="07XXX XXXXXX">
                    </div>
                    <div class="form-group">
                        <label>Email Address *</label>
                        <input type="email" id="enquiryEmail" required placeholder="your.email@example.com">
                    </div>
                    <div class="form-group">
                        <label>Your Postcode *</label>
                        <input type="text" id="enquiryPostcode" required placeholder="e.g., L30 1RD">
                    </div>
                    <div class="form-group">
                        <label>Message (Optional)</label>
                        <textarea id="enquiryMessage" placeholder="Any specific questions or preferred contact times..."></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary" style="width: 100%;">Submit Request</button>
                </form>
            `;
            
            detailModal.classList.add('active');
        }
        
        // Submit enquiry form
        function submitEnquiry(event, installId, type) {
            event.preventDefault();
            
            const installation = installations.find(i => i.id === installId);
            const name = document.getElementById('enquiryName').value;
            const phone = document.getElementById('enquiryPhone').value;
            const email = document.getElementById('enquiryEmail').value;
            const postcode = document.getElementById('enquiryPostcode').value;
            const message = document.getElementById('enquiryMessage').value;
            
            const typeText = type === 'phone' ? 'phone call' : 'property visit';
            
            // Create enquiry object
            const enquiry = {
                type,
                customerName: name,
                phone,
                email,
                postcode,
                message,
                interestedInInstallation: installation.id,
                installationAddress: installation.address,
                installationCustomer: installation.customerName,
                technologies: installation.technologyTypes || [installation.technologyType],
                product: installation.productInstalled,
                timestamp: new Date().toISOString()
            };
            
            // Store enquiry
            const enquiries = JSON.parse(localStorage.getItem('abacus_enquiries') || '[]');
            enquiries.push(enquiry);
            localStorage.setItem('abacus_enquiries', JSON.stringify(enquiries));
            
            // Show success message
            const detailContent = document.getElementById('detailContent');
            detailContent.innerHTML = `
                <div style="text-align: center; padding: 2rem;">
                    <div style="font-size: 4rem; margin-bottom: 1rem;">‚úÖ</div>
                    <h3 style="color: #2E4591; margin-bottom: 1rem;">Request Received!</h3>
                    <p style="color: #4a5568; line-height: 1.6; margin-bottom: 1.5rem;">
                        Thank you ${name}! We've received your request for a ${typeText}.<br><br>
                        One of our team will be in touch with you shortly on <strong>${phone}</strong> or <strong>${email}</strong> to arrange for you to speak with the customer about their installation experience.
                    </p>
                    <button onclick="closeDetailModal()" class="btn btn-primary">Close</button>
                </div>
            `;
        }

        // Delete installation
        function deleteInstallation(installId) {
            const installation = installations.find(i => i.id === installId);
            if (!installation) return;
            
            if (!confirm(`Are you sure you want to delete the installation for ${installation.customerName}?\n\nThis action cannot be undone.`)) {
                return;
            }
            
            // Remove from array
            installations = installations.filter(i => i.id !== installId);
            saveInstallations();
            
            // Close any open popups
            map.closePopup();
            
            // Re-render
            renderInstallations();
            
            alert('Installation deleted successfully.');
        }

        // Show installation detail
        function showDetail(id) {
            const installation = installations.find(i => i.id === id);
            if (!installation) return;

            const detailContent = document.getElementById('detailContent');
            
            const imagesHtml = installation.images.length > 0
                ? `<div class="detail-images">
                     ${installation.images.map(img => `<img src="${img}" alt="${installation.customerName}" onclick="window.open('${img}')">`).join('')}
                   </div>`
                : '<p style="color:#718096;">No images available</p>';
            
            const detailTechs = installation.technologyTypes || (installation.technologyType ? [installation.technologyType] : ['solar']);
            const detailTechLabels = detailTechs.map(t => getTechnologyLabel(t)).join(', ');

            detailContent.innerHTML = `
                <div class="detail-info">
                    <h3>${installation.customerName}</h3>
                    <p><strong>Technologies:</strong> ${detailTechLabels}</p>
                    <p><strong>Product Installed:</strong> ${installation.productInstalled}</p>
                    <p><strong>Address:</strong> ${installation.address}</p>
                    <p><strong>Installation Date:</strong> ${formatDateBritish(installation.installDate)}</p>
                    ${installation.description ? `<p><strong>Description:</strong> ${installation.description}</p>` : ''}
                </div>
                ${imagesHtml}
                ${isAdminMode ? `<button class="btn-delete" onclick="deleteInstallation(${installation.id}); closeDetailModal();">üóëÔ∏è Delete This Installation</button>` : ''}
            `;

            document.getElementById('detailModal').classList.add('active');
        }

        // Modal controls
        function openAddModal() {
            document.getElementById('addModal').classList.add('active');
        }

        function closeAddModal() {
            document.getElementById('addModal').classList.remove('active');
        }

        function closeDetailModal() {
            document.getElementById('detailModal').classList.remove('active');
        }

        // Export data
        function exportData() {
            const dataStr = JSON.stringify(installations, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `abacus-installations-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
        }

        // Close modals on background click
        document.getElementById('addModal').addEventListener('click', function(e) {
            if (e.target === this) closeAddModal();
        });

        document.getElementById('detailModal').addEventListener('click', function(e) {
            if (e.target === this) closeDetailModal();
        });

        // Initialize
        renderInstallations();
    </script>
</body>
</html>